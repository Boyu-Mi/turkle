{% extends 'admin/change_form.html' %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
/** Hide file form field  */
#id_template_file {
  display: none;
}
</style>
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script type="text/javascript" src="{% static 'hits/jquery-3.3.1.min.js' %}"></script>
<script type="text/javascript" src="{% static 'hits/jQuery-File-Upload-9.22.0/js/vendor/jquery.ui.widget.js' %}"></script>
<script type="text/javascript" src="{% static 'hits/jQuery-File-Upload-9.22.0/js/jquery.iframe-transport.js' %}"></script>
<script type="text/javascript" src="{% static 'hits/jQuery-File-Upload-9.22.0/js/jquery.fileupload.js' %}"></script>
<script type="text/javascript">
$(function () {
  $('#id_template_file').fileupload({
    add: function (e, data) {
      var reader = new FileReader();
      reader.onload = (function(theFile) {
        var fileContents = theFile.target.result;
        $('#id_form').val(fileContents);
      });
      reader.readAsText(data.files[0]);
    },
  });

  // The default appearance for a file form field (at least on Safari)
  // is a button that says "Choose File" followed by text that says
  // "no file selected".
  //
  // When jQuery File Upload's fileupload() is used on a file field,
  // the "no file selected" text stops being updated when a file is
  // added to the form.  To the user, this makes it seem like file
  // uploading has failed even if it succeeded.
  //
  // The jQuery File Upload widget includes CSS styles that hide the
  // original file field button (with unchanging "no file selected"
  // text) and add a different button.
  //
  // Because the HTML for the file field is generated by Django, and
  // because integrating the jQuery File Upload CSS Into the Django
  // admin interface is not a hot idea, we rolled our own solution.
  //
  // The CSS at the top of this template file hides the file field, while
  // the JavaScript below adds a label (styled as a button) that
  // activates the (hidden) file field, causing a file-browsing dialog box
  // to appear.
  //
  // Adapted from:
  //   https://stackoverflow.com/questions/16001586/change-the-no-file-chosen
  var betterLookingButtonSpan =
    $('<span id="template_file_span">').append(
      $('<label for="id_template_file" class="button" style="text-align: center;">Choose File</label>'));
  $('#id_template_file').after(betterLookingButtonSpan);
});
</script>
{% endblock %}
