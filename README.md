# Turkle #

Run a clone of Amazon's Mechanical **Turk** service in your **l**ocal
**e**nvironment.

This tool is meant to be used as a web service running locally on your network
or personal machine. It will load HIT template files generated by the Amazon
Mechanical Turk web GUI provided to requesters for creating HITs. Input CSV files are
also uploaded to create a HIT based on the template with each row of
values in the CSV file.

The results of the HITs completed by the workers can be exported in CSV files.


# Installation #

Turkle works with either python 2 or python 3.

## Dependencies ##

- Turkle depends on the packages listed in `requirements.txt`.
  If the packages are not already installed in your environment, and you have
  an internet connection, then you can run the following command to install
  the required Python packages:

  ```bash
  pip install -r requirements.txt
  ```

  Using a virtual environment has the advantage of keeping the dependencies
  for this project separate from other projects. The actual syntax depends
  on what virtual environment package you are using, but it should work like this: 

  ```bash
  virtualenv venv
  source venv/bin/activate
  pip install -r requirements.txt
  ```

## Setup ##

After the dependencies have been installed, you create and initialize the db:

```bash
python manage.py migrate
python manage.py createsuperuser
```

## Configuration ##

To streamline worker task completion, submission of a HIT can
automatically load the next unfinished HIT.  To enable this setting
change `NEXT_HIT_ON_SUBMIT` to `True` at the bottom of `settings.py`
in the turkle sub-directory.

After changing settings, the web server will need to be restarted for
changes to take effect.

# Usage

The administrator loads HITs for the worker(s) to complete.
There are example HITS in the `examples` directory.
A batch of HITs consists of an HTML template and corresponding CSV data files.

## Running the server ##

```bash
python manage.py runserver
```

## Creating user accounts ##

### Using the admin UI
 * Login with a super user account
 * Select Manage Users from the navigation header
 * Click the `Add User` button, fill out the form and submit

### Using the scripts
The `add_user.py` script adds a single user. Run it with the `-h` option for details.

The `import_users.py` script reads a CSV file to add users to Turkle.
The file must be formatted like:
```
username1,password1
username2,password2
```

## Loading a batch of HITs ##

### Using the admin UI

TODO: documentation on using the admin UI for templates and CSVs.

### Using the scripts
With a template html file and a batch CSV file, use the 
`publish_hits.py` script to add them to Turkle.
If you have already added the template, you must use the admin UI
to add additional batches of HITs.

## Downloading a batch of HITs ##

### Using the admin UI

TODO

### Using the scripts
The `download_results.py` script downloads all HITs that have been completed
into a directory that the user selects.

# Worker instructions

Use your web browser to visit [http://localhost:8000](http://localhost:8000)
Log in if you've been given user credentials.
Find your assigned set of HITs and click the "Accept next HIT" button.

# Docker usage

Instead of installing Turkle and dependencies directly, you can run Turkle as a Docker container, using scripts to manage your HIT templates and data.
Either build a Turkle image:

```bash
docker build --force-rm -t hltcoe/turkle .
```

or pull the latest from the Docker registry:

```bash
docker pull hltcoe/turkle
```

and start a container with an easy name, and mapping container port 8080 somewhere on the Docker host (e.g. 18080):

```bash
docker run -d --name container_name -p 18080:8080 hltcoe/turkle
```

Your annotator can now browse to that port on the Docker host.  To give them something to do, upload an Amazon Turk HIT template and data:

```bash
python scripts/publish_hits.py -u [superuser] --server localhost:18080 template.html data.csv
```

At any point, you can download the current state of annotations:

```bash
python scripts/download_results.py -u [superuser] --server localhost:18080
```
